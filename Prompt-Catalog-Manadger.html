<!DOCTYPE html>
<html lang="ru">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Менеджер Промптов</title>

    <!-- Bootstrap CSS -->
    <link
      href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css"
      rel="stylesheet"
      xintegrity="sha384-QWTKZyjpPEjISv5WaRU9OFeRpok6YctnYmDr5pNlyT2bRjXh0JMhjY6hW+ALEwIH"
      crossorigin="anonymous"
    />

    <!-- Bootstrap Icons -->
    <link
      rel="stylesheet"
      href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.3/font/bootstrap-icons.min.css"
    />

    <!-- Custom Styles -->
    <style>
      :root {
        --primary-color: #34568b; /* Сине-серый */
        --secondary-color: #6c757d; /* Серый */
        --light-bg: #f8f9fa;
        --border-color: #dee2e6;
        --card-bg: #ffffff;
        --text-color: #212529;
      }

      body {
        background-color: var(--light-bg);
        color: var(--text-color);
        font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, "Helvetica Neue", Arial, sans-serif, "Apple Color Emoji", "Segoe UI Emoji", "Segoe UI Symbol";
      }

      .container {
        max-width: 1200px;
        margin-top: 2rem;
        margin-bottom: 2rem;
      }

      .header {
        background-color: var(--primary-color);
        color: white;
        padding: 1rem;
        border-radius: 0.5rem;
        text-align: center;
        margin-bottom: 2rem;
        box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
      }

      .header h1 {
        font-size: 1.75rem;
        margin-bottom: 0.25rem;
      }

      .header p {
        font-size: 1rem;
        margin-bottom: 0;
      }

      .card {
        background-color: var(--card-bg);
        border: 1px solid var(--border-color);
        border-radius: 0.5rem;
        box-shadow: 0 2px 4px rgba(0, 0, 0, 0.05);
        height: 100%;
      }

      .prompt-card .card-text {
        min-height: 80px;
        display: -webkit-box;
        -webkit-line-clamp: 4;
        -webkit-box-orient: vertical;
        overflow: hidden;
      }

      .nav-tabs .nav-link {
        color: var(--secondary-color);
        border-color: var(--border-color);
      }

      .nav-tabs .nav-link.active {
        color: var(--primary-color);
        background-color: var(--card-bg);
        border-color: var(--border-color) var(--border-color) var(--card-bg);
      }

      .btn-primary {
        background-color: var(--primary-color);
        border-color: var(--primary-color);
      }

      .btn-primary:hover {
        background-color: #2c476f;
        border-color: #2c476f;
      }

      .prompt-variations {
        margin-top: 1rem;
      }

      .form-control.is-invalid {
        border-color: #dc3545;
        padding-right: 2.25rem;
        background-image: url("data:image/svg+xml,%3csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 12 12' width='12' height='12' fill='none' stroke='%23dc3545'%3e%3ccircle cx='6' cy='6' r='4.5'/%3e%3cpath stroke-linecap='round' d='M5.8 3.6h.4L6 6.5z'/%3e%3ccircle cx='6' cy='8.2' r='.6' fill='%23dc3545' stroke='none'/%3e%3c/svg%3e");
        background-repeat: no-repeat;
        background-position: right calc(0.375em + 0.1875rem) center;
        background-size: calc(0.75em + 0.375rem) calc(0.75em + 0.375rem);
      }

      /* Styles for offcanvas menu */
      .offcanvas-header {
        background-color: var(--primary-color);
        color: white;
      }

      .offcanvas-title {
        color: white;
      }

      .offcanvas-body .list-group-item {
        cursor: pointer;
      }

      .offcanvas-body .list-group-item.active {
        background-color: var(--primary-color);
        border-color: var(--primary-color);
        color: white;
      }

      /* Adjustments for mobile view */
      @media (max-width: 767px) {
        .d-md-flex {
          flex-direction: column;
        }
        .order-md-2 {
          order: 2;
        }
        .order-md-1 {
          order: 1;
        }
      }
    </style>
  </head>
  <body>
    <!-- Main Container -->
    <div class="container">
      <!-- Header -->
      <header class="header">
        <h1>Менеджер Промптов</h1>
        <p>Создавайте, храните и управляйте вашими промптами</p>
      </header>

      <!-- Main Content -->
      <main class="row">
        <!-- Prompt Controls -->
        <div class="col-12 mb-4">
          <div class="d-flex justify-content-between align-items-center">
            <!-- Offcanvas trigger for mobile -->
            <button
              class="btn btn-outline-secondary d-md-none"
              type="button"
              data-bs-toggle="offcanvas"
              data-bs-target="#offcanvasMenu"
              aria-controls="offcanvasMenu"
            >
              <i class="bi-list"></i>
              <span class="ms-1">Меню</span>
            </button>
            <!-- Dropdown for desktop -->
            <div class="dropdown d-none d-md-block">
              <button
                class="btn btn-primary dropdown-toggle"
                type="button"
                id="promptDropdown"
                data-bs-toggle="dropdown"
                aria-expanded="false"
              >
                Выберите промпт
              </button>
              <ul class="dropdown-menu" aria-labelledby="promptDropdown" id="promptDropdownMenu">
                <!-- Dropdown items will be rendered here by JS -->
              </ul>
            </div>
            
            <button
              id="addPromptBtn"
              class="btn btn-outline-primary"
              data-bs-toggle="modal"
              data-bs-target="#promptModal"
            >
              <i class="bi-plus-circle-fill"></i>
              <span class="ms-1">Добавить промпт</span>
            </button>
          </div>
        </div>

        <!-- Prompt Content -->
        <div class="col-12">
          <div
            class="tab-content border bg-white p-4 rounded-3"
            id="prompt-tab-content"
          >
            <!-- Tab content will be rendered here by JS -->
            <div class="tab-pane fade show active" id="no-prompt-selected">
              <p class="text-muted text-center py-5">
                Выберите промпт из списка, или создайте новый.
              </p>
            </div>
          </div>
        </div>
      </main>
    </div>

    <!-- Offcanvas Menu for Mobile -->
    <div
      class="offcanvas offcanvas-start"
      tabindex="-1"
      id="offcanvasMenu"
      aria-labelledby="offcanvasMenuLabel"
    >
      <div class="offcanvas-header">
        <h5 class="offcanvas-title" id="offcanvasMenuLabel">Меню промптов</h5>
        <button
          type="button"
          class="btn-close text-reset"
          data-bs-dismiss="offcanvas"
          aria-label="Close"
        ></button>
      </div>
      <div class="offcanvas-body">
        <div class="list-group" id="mobilePromptList">
          <!-- List items will be rendered here by JS -->
        </div>
      </div>
    </div>

    <!-- Modals and Toasts here... -->

    <!-- Prompt Modal (Add/Edit) -->
    <div
      class="modal fade"
      id="promptModal"
      tabindex="-1"
      aria-labelledby="promptModalLabel"
      aria-hidden="true"
    >
      <div class="modal-dialog modal-lg">
        <div class="modal-content">
          <div class="modal-header">
            <h5 class="modal-title" id="promptModalLabel">Новый промпт</h5>
            <button
              type="button"
              class="btn-close"
              data-bs-dismiss="modal"
              aria-label="Close"
            ></button>
          </div>
          <div class="modal-body">
            <form id="promptForm">
              <div class="mb-3">
                <label for="promptTabNameInput" class="form-label"
                  >Название промпта</label
                >
                <input
                  type="text"
                  class="form-control"
                  id="promptTabNameInput"
                  required
                />
                <div class="invalid-feedback">
                  Пожалуйста, введите название промпта.
                </div>
              </div>

              <div id="variationsContainer">
                <h6 class="mb-3">Вариации</h6>
                <!-- Variations will be dynamically added here -->
              </div>
              <button type="button" class="btn btn-sm btn-outline-secondary" id="addVariationBtn">
                <i class="bi-plus-lg"></i> Добавить вариацию
              </button>
            </form>
          </div>
          <div class="modal-footer">
            <button
              type="button"
              class="btn btn-secondary"
              data-bs-dismiss="modal"
            >
              Отмена
            </button>
            <button type="button" class="btn btn-primary" id="savePromptBtn">
              Сохранить
            </button>
          </div>
        </div>
      </div>
    </div>

    <!-- Delete Confirmation Modal -->
    <div
      class="modal fade"
      id="deleteConfirmModal"
      tabindex="-1"
      aria-labelledby="deleteConfirmModalLabel"
      aria-hidden="true"
    >
      <div class="modal-dialog">
        <div class="modal-content">
          <div class="modal-header">
            <h5 class="modal-title" id="deleteConfirmModalLabel">
              Удалить промпт
            </h5>
            <button
              type="button"
              class="btn-close"
              data-bs-dismiss="modal"
              aria-label="Close"
            ></button>
          </div>
          <div class="modal-body">
            Вы уверены, что хотите удалить этот промпт?
          </div>
          <div class="modal-footer">
            <button
              type="button"
              class="btn btn-secondary"
              data-bs-dismiss="modal"
            >
              Отмена
            </button>
            <button type="button" class="btn btn-danger" id="confirmDeleteBtn">
              Удалить
            </button>
          </div>
        </div>
      </div>
    </div>

    <!-- Toast Container for Notifications -->
    <div class="toast-container position-fixed bottom-0 end-0 p-3">
      <div
        id="copyToast"
        class="toast"
        role="alert"
        aria-live="assertive"
        aria-atomic="true"
      >
        <div class="toast-header">
          <i class="bi-check-circle-fill text-success me-2"></i>
          <strong class="me-auto">Скопировано!</strong>
          <small class="text-body-secondary">Сейчас</small>
          <button
            type="button"
            class="btn-close"
            data-bs-dismiss="toast"
            aria-label="Close"
          ></button>
        </div>
        <div class="toast-body">Текст промпта скопирован в буфер обмена.</div>
      </div>
    </div>

    <!-- Bootstrap JS -->
    <script
      src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"
      xintegrity="sha384-YvpcrYf0tY3lHB60NNkmXc5s9fDVZLESaAA55NDzOxhy9GkcIdslK1eN7N6jIeHz"
      crossorigin="anonymous"
    ></script>

    <script>
      document.addEventListener("DOMContentLoaded", () => {
        // --- DATA & STATE ---
        let prompts = [];
        let promptIdToEdit = null;
        let promptIdToDelete = null;
        let activePromptId = null;

        const defaultPrompts = [
          {
            id: 'd1',
            tabName: "Переводчик",
            isDefault: true,
            variations: [
              {
                id: 'v1',
                title: "С английского на русский",
                text: "Переведи следующий текст с английского на русский язык и сохрани исходный стиль: {{TEXT}}",
              },
              {
                id: 'v2',
                title: "С русского на английский",
                text: "Переведи следующий текст с русского на английский язык и сохрани исходный стиль: {{TEXT}}",
              },
            ],
          },
          {
            id: 'd2',
            tabName: "Резюмирование",
            isDefault: true,
            variations: [
              {
                id: 'v3',
                title: "Краткое резюме",
                text: "Сделай краткое резюме следующего текста, выделив основные идеи и ключевые моменты: {{TEXT}}",
              },
              {
                id: 'v4',
                title: "Подробное резюме",
                text: "Сделай подробное резюме следующего текста, с акцентом на факты, детали и примеры: {{TEXT}}",
              },
            ],
          },
          {
            id: 'default-1',
            tabName: 'Транскрипция текста с изображения',
            isDefault: true,
            variations: [
                { title: 'Вариант 1: Сбалансированный и универсальный (рекомендуется)', text: 'Сделай дословную транскрипцию всего текста с изображения. Строго следуй этим правилам:\n1.  **Точность:** Копируй текст символ в символ, включая все опечатки, ошибки и знаки препинания.\n2.  **Структура:** Сохраняй все переносы строк, абзацы и множественные пробелы.\n3.  **Форматирование:** Визуальный стиль (жирный, курсив) передавай с помощью Markdown (**жирный**, *курсив*).\n4.  **Запрет на редактирование:** Ничего не исправляй, не дополняй и не изменяй.' },
                { title: 'Вариант 2: Лаконичный (для быстрого использования)', text: 'Извлеки текст с изображения как есть, без каких-либо изменений. Сохраняй регистр, пунктуацию, ошибки и все пробелы. Форматирование (жирный, курсив) передай через Markdown.' },
                { title: 'Вариант 3: Максимальный контроль (для сложных документов)', text: 'Создай точную текстовую копию (транскрипцию) документа с изображения, соблюдая следующие требования:\n-   **Дословность:** Текст должен быть воспроизведен на 100% идентично, включая грамматические и орфографические ошибки.\n-   **Сохранение структуры:** Воспроизведи все абзацы, разрывы строк и отступы, используя символы пробела и переноса строки.\n-   **Передача форматирования:**\n    -   Жирный текст заключай в **звездочки**.\n    -   Курсив — в *звездочки*.\n    -   Списки воспроизводи с сохранением маркеров (-, *, 1.).\n    -   Если на изображении есть таблица, представь её в виде Markdown-таблицы.\n-   **Запрет на интерпретацию:** Не добавляй никакого текста, комментариев или исправлений, которых нет в источнике.' }
            ]
          },
          {
            id: 'default-2',
            tabName: 'Структурирование и форматирование текста',
            isDefault: true,
            variations: [
                { title: 'Вариант 1: Максимальная читаемость и структура', text: '**Роль:** Ты — эксперт по информационному дизайну и UX-копирайтингу. Твоя задача — не просто форматировать текст, а улучшать его восприятие и усвоение информации.\n\n**Задача:** Возьми предоставленный ниже текст и преобразуй его в идеально структурированный Markdown-документ. Главная цель — максимальная читаемость и понятность для профессиональной аудитории. Ты можешь незначительно изменять формулировки для ясности и добавлять логические связки, но основной смысл должен быть сохранен.\n\n**Инструкции:**\n1.  **Структура и заголовки:** Проанализируй текст и разбей его на логические блоки. Для каждого блока создай информативные заголовки и подзаголовки (#, ##, ###).\n2.  **Списки:** Все перечисления, шаги или ключевые пункты оформи в виде маркированных (*) или нумерованных (1.) списков.\n3.  **Акценты:** Выдели ключевые термины и важные идеи с помощью жирного шрифта и курсива. Делай это умеренно, чтобы не перегружать текст.\n4.  **Цитаты:** Если в тексте есть прямые цитаты, мнения экспертов или особенно важные выводы, оформи их как цитаты (>).\n5.  **Таблицы:** Если найдешь данные, которые можно логично представить в виде таблицы (сравнения, характеристики), создай её.\n6.  **Читаемость абзацев:** Длинные абзацы разбей на более короткие (3-5 строк) для облегчения сканирования текста.\n7.  **Ссылки:** Если в тексте есть URL-адреса, преврати их в осмысленные гиперссылки.\n\n**Текст для обработки:**\n[СЮДА ВСТАВИТЬ ИСХОДНЫЙ ТЕКСТ]' },
                { title: 'Вариант 2: Эффектная и «живая» подача', text: '**Роль:** Ты — креативный контент-маркетолог и специалист по визуализации. Твоя задача — превратить сухой текст в яркий, запоминающийся и визуально привлекательный материал.\n\n**Задача:** Возьми предоставленный ниже текст и отформатируй его в Markdown, используя максимум креативных возможностей для эффектной подачи. Цель — удержать внимание читателя и произвести "вау-эффект". Ты можешь свободно изменять структуру текста, добавлять визуальные элементы и перефразировать для большей убедительности.\n\n**Инструкции:**\n1.  **Броские заголовки:** Создай цепляющие заголовки и подзаголовки. Можно добавить к ним релевантные эмодзи (например, ## 🚀 Основные преимущества).\n2.  **Эмодзи и иконки:** Активно, но уместно используй эмодзи в тексте и списках, чтобы проиллюстрировать идеи (✅, ➡️, 🎯).\n3.  **Визуальные акценты с HTML:** Используй базовые HTML-теги для выделения цветом ключевых фраз. Например: ...сэкономить до 50% времени.\n4.  **Эффект "слайдов":** Разделяй крупные логические блоки с помощью горизонтальной линии (---).\n5.  **Ключевые выводы (Key Takeaways):** Самые важные мысли оформи в виде блока с цитатой и иконкой, например: > 💡 **Главная мысль:** ...\n6.  **Призывы к действию (CTA):** Если в тексте есть подразумеваемый призыв к действию, выдели его жирным шрифтом или в виде цитаты.\n\n**Текст для обработки:**\n[СЮДА ВСТАВИТЬ ИСХОДНЫЙ ТЕКСТ]' },
                { title: 'Вариант 3: Сбалансированный (оптимизированная формулировка)', text: 'Преобразуй предоставленный текст в формат Markdown, не сокращая исходное содержание.\n\nСфокусируйся на двух целях:\n1.  **Читаемость:** Используй заголовки, подзаголовки, списки, выделения, таблицы, цитаты и ссылки для создания чёткой и логичной структуры.\n2.  **Эффектность:** Добавь уместные визуальные элементы (эмодзи, цветовое оформление через HTML) для более яркой и запоминающейся подачи.\n\nСделай оформление максимально выразительным, но при этом профессиональным и удобным для восприятия.\n\n**Текст для обработки:**\n[СЮДА ВСТАВИТЬ ИСХОДНЫЙ ТЕКСТ]' }
            ]
          },
          {
            id: 'default-3',
            tabName: 'Промпты для расшифровки аудио',
            isDefault: true,
            variations: [
                { title: 'Вариант 1 — Строгое соблюдение сказанного', text: 'Создайте текстовую расшифровку аудио, строго соблюдая:\n\n1. Воспроизводите речь максимально дословно: не удаляйте слов-паразитов, повторов или пауз.\n2. Для неразборчивых фрагментов используйте [Неразборчиво], для шумов — [Шум].\n3. Добавляйте временные метки [мм:сс] в начале каждого смыслового блока или при смене темы.\n4. Ставьте корректные знаки препинания и разделяйте текст на смысловые абзацы.\n5. Сначала документа дайте: • краткое резюме содержания; • список основных тем с временными метками.\n6. В тексте выделяйте ключевые моменты жирным (`**`).\n7. Итоговый формат: Markdown (`##` — заголовки, `**` — выделение).\n8. Не добавляйте ничего, чего нет в аудио.' },
                { title: 'Вариант 2 — С возможным редактированием', text: 'Создайте текстовую расшифровку аудио, соблюдая:\n\n1. Передавайте речь максимально точно, но допускайте лёгкое редактирование: • удаляйте слова-паразиты (например, "ну", "как бы", "типа", "вот"); • убирайте бессмысленные повторы. Смысл должен быть сохранён, текст читаемым.\n2. Для неразборчивых фрагментов используйте [Неразборчиво], для шумов — [Шум].\n3. Добавляйте временные метки [мм:сс] в начале каждого смыслового блока или при смене темы.\n4. Ставьте знаки препинания и разделяйте текст на абзацы по смыслу.\n5. В начале документа разместите: • краткое резюме содержания; • список основных тем с временными метками.\n6. В тексте выделяйте ключевые моменты жирным (`**`).\n7. Итоговый формат: Markdown (`##` — заголовки, `**` — выделение).\n8. Не добавляйте информацию, отсутствующую в аудио.' }
            ]
          }
        ];

        // --- DOM ELEMENTS ---
        const promptDropdownBtn = document.getElementById("promptDropdown");
        const promptDropdownMenu = document.getElementById("promptDropdownMenu");
        const promptTabContentEl = document.getElementById("prompt-tab-content");
        const promptModalEl = document.getElementById("promptModal");
        const deleteConfirmModalEl = document.getElementById("deleteConfirmModal");
        const promptModal = new bootstrap.Modal(promptModalEl);
        const deleteConfirmModal = new bootstrap.Modal(deleteConfirmModalEl);
        const addPromptBtn = document.getElementById("addPromptBtn");
        const savePromptBtn = document.getElementById("savePromptBtn");
        const confirmDeleteBtn = document.getElementById("confirmDeleteBtn");
        const addVariationBtn = document.getElementById("addVariationBtn");
        const copyToast = new bootstrap.Toast(document.getElementById("copyToast"));
        const promptTabNameInput = document.getElementById("promptTabNameInput");
        const mobilePromptList = document.getElementById("mobilePromptList");

        // --- DATA FUNCTIONS ---
        function loadPrompts() {
          const storedPrompts = localStorage.getItem("prompts");
          if (storedPrompts) {
            prompts = JSON.parse(storedPrompts);
          } else {
            prompts = defaultPrompts;
            savePrompts();
          }
          if (prompts.length > 0) {
            activePromptId = prompts[0].id;
          }
        }

        function savePrompts() {
          localStorage.setItem("prompts", JSON.stringify(prompts));
        }

        function findPrompt(id) {
          return prompts.find((p) => p.id === id);
        }

        function getActivePrompt() {
          return findPrompt(activePromptId);
        }

        // --- RENDER FUNCTIONS ---
        function renderUI() {
          renderDesktopDropdown();
          renderMobileMenu();
          renderContent();
        }

        function renderDesktopDropdown() {
          promptDropdownMenu.innerHTML = "";
          const activePrompt = getActivePrompt();
          if (activePrompt) {
            promptDropdownBtn.textContent = activePrompt.tabName;
          } else {
            promptDropdownBtn.textContent = "Выберите промпт";
          }
          
          prompts.forEach((prompt) => {
            const isActive = prompt.id === activePromptId;
            const itemHTML = `
              <li><a class="dropdown-item ${isActive ? 'active' : ''}" href="#" data-id="${prompt.id}">${prompt.tabName}</a></li>
            `;
            promptDropdownMenu.insertAdjacentHTML("beforeend", itemHTML);
          });
          
          promptDropdownMenu.querySelectorAll('.dropdown-item').forEach(item => {
            item.addEventListener('click', (e) => {
              e.preventDefault();
              activePromptId = e.target.dataset.id;
              renderUI();
            });
          });
        }

        function renderMobileMenu() {
          mobilePromptList.innerHTML = "";
          const activePrompt = getActivePrompt();

          prompts.forEach((prompt) => {
            const isActive = prompt.id === activePromptId;
            const itemHTML = `
              <a href="#" class="list-group-item list-group-item-action ${isActive ? 'active' : ''}" data-id="${prompt.id}" data-bs-dismiss="offcanvas">
                ${prompt.tabName}
              </a>
            `;
            mobilePromptList.insertAdjacentHTML("beforeend", itemHTML);
          });
          
          mobilePromptList.querySelectorAll('.list-group-item').forEach(item => {
            item.addEventListener('click', (e) => {
              e.preventDefault();
              activePromptId = e.target.dataset.id;
              renderUI();
            });
          });
        }

        function renderContent() {
          promptTabContentEl.innerHTML = "";
          const activePrompt = getActivePrompt();

          if (!activePrompt) {
            promptTabContentEl.innerHTML = `
              <div class="tab-pane fade show active" id="no-prompt-selected">
                <p class="text-muted text-center py-5">
                  Выберите промпт из списка, или создайте новый.
                </p>
              </div>
            `;
            return;
          }

          const variationsHTML = activePrompt.variations
            .map(
              (variation) => `
              <div class="col-md-6 mb-4">
                <div class="card h-100">
                  <div class="card-body d-flex flex-column">
                    <h5 class="card-title">${variation.title}</h5>
                    <p class="card-text text-muted flex-grow-1">
                      ${variation.text}
                    </p>
                    <div class="mt-auto d-flex justify-content-end gap-2">
                      <button class="btn btn-sm btn-outline-primary copy-btn" data-clipboard-target="#variation-${variation.id}">
                        <i class="bi-clipboard"></i>
                        <span class="d-lg-none d-xl-inline">Копировать</span>
                      </button>
                      <button class="btn btn-sm btn-outline-secondary edit-btn" data-id="${activePrompt.id}" data-variation-id="${variation.id}">
                        <i class="bi-pencil"></i>
                        <span class="d-lg-none d-xl-inline">Редактировать</span>
                      </button>
                    </div>
                    <textarea id="variation-${variation.id}" class="d-none">${variation.text}</textarea>
                  </div>
                </div>
              </div>
            `
            )
            .join("");

          const tabContentHTML = `
            <div
              class="tab-pane fade show active"
              id="content-${activePrompt.id}"
              role="tabpanel"
            >
              <div class="d-flex justify-content-between align-items-center mb-3">
                <h5 class="d-md-none mb-0">${activePrompt.tabName}</h5>
                <div class="ms-auto d-flex">
                  <button class="btn btn-sm btn-outline-secondary me-2 edit-btn" data-id="${activePrompt.id}" data-variation-id="">
                    <i class="bi-pencil-fill"></i>
                    <span class="d-none d-lg-inline ms-1">Редактировать</span>
                  </button>
                  ${
                    !activePrompt.isDefault
                      ? `<button class="btn btn-sm btn-outline-danger delete-btn" data-id="${activePrompt.id}">
                            <i class="bi-trash"></i>
                            <span class="d-none d-lg-inline ms-1">Удалить</span>
                        </button>`
                      : ""
                  }
                </div>
              </div>
              <div class="row g-3">
                ${variationsHTML}
              </div>
            </div>
          `;
          promptTabContentEl.insertAdjacentHTML("beforeend", tabContentHTML);
        }

        // --- EVENT LISTENERS (DELEGATED) ---
        function addEventListenersToControls() {
            // Используем делегирование событий на родительском контейнере
            document.addEventListener('click', (e) => {
                const target = e.target.closest('.edit-btn, .delete-btn, .copy-btn');
                if (!target) return;

                // Клик на кнопке редактирования промпта/вариации
                if (target.classList.contains('edit-btn')) {
                    const promptId = target.dataset.id;
                    const variationId = target.dataset.variationId;
                    handleEdit(promptId, variationId);
                }
                
                // Клик на кнопке удаления промпта
                else if (target.classList.contains('delete-btn')) {
                    const promptId = target.dataset.id;
                    handleDelete(promptId);
                }

                // Клик на кнопке копирования
                else if (target.classList.contains('copy-btn')) {
                    const targetId = target.dataset.clipboard-target;
                    const textToCopy = document.querySelector(targetId).value;

                    // Создаем временное поле для копирования
                    const tempInput = document.createElement('textarea');
                    tempInput.value = textToCopy;
                    document.body.appendChild(tempInput);
                    tempInput.select();
                    
                    try {
                        document.execCommand('copy');
                        copyToast.show();
                    } catch (err) {
                        console.error('Failed to copy text: ', err);
                    }
                    
                    document.body.removeChild(tempInput);
                }
            });

            // Слушатель для кнопки сохранения промпта в модальном окне
            savePromptBtn.addEventListener('click', savePrompt);
        }

        // --- HANDLERS ---
        function handleAdd() {
          promptIdToEdit = null;
          document.getElementById("promptModalLabel").textContent = "Новый промпт";
          document.getElementById("promptTabNameInput").value = "";
          renderVariationsForm(); 
          promptModal.show();
        }

        function handleEdit(id, variationId = null) {
          const promptToEdit = findPrompt(id);
          if (!promptToEdit) return;

          promptIdToEdit = id;
          document.getElementById("promptModalLabel").textContent = `Редактировать: ${promptToEdit.tabName}`;
          document.getElementById("promptTabNameInput").value = promptToEdit.tabName;

          if (variationId) {
            const variation = promptToEdit.variations.find(v => v.id === variationId);
            renderVariationsForm([variation]);
          } else {
            renderVariationsForm(promptToEdit.variations);
          }
          
          promptModal.show();
        }

        function handleDelete(id) {
            promptIdToDelete = id;
            deleteConfirmModal.show();
        }

        function renderVariationsForm(variations = [{ title: "", text: "" }]) {
          const variationsContainer = document.getElementById("variationsContainer");
          variationsContainer.innerHTML = "";

          variations.forEach((variation, index) => {
            const variationHTML = `
              <div class="card p-3 mb-3">
                <div class="d-flex justify-content-between align-items-center mb-2">
                  <label for="variationTitle${index}" class="form-label mb-0">Заголовок</label>
                  <button type="button" class="btn btn-sm btn-outline-danger delete-variation-btn" data-index="${index}">
                      <i class="bi-trash"></i>
                  </button>
                </div>
                <div>
                  <input type="text" class="form-control variation-title" id="variationTitle${index}" value="${variation.title}" data-index="${index}" required />
                </div>
                <div class="mt-2">
                  <label for="variationText${index}" class="form-label">Текст промпта</label>
                  <textarea class="form-control variation-text" id="variationText${index}" rows="3" data-index="${index}" required>${variation.text}</textarea>
                </div>
              </div>
            `;
            variationsContainer.insertAdjacentHTML("beforeend", variationHTML);
          });
          addDeleteVariationListeners();
        }
        
        function addVariationField() {
            const variationsContainer = document.getElementById('variationsContainer');
            const variationCount = document.querySelectorAll('.variation-title').length;
            const newVariationHTML = `
                <div class="card p-3 mb-3">
                    <div class="d-flex justify-content-between align-items-center mb-2">
                        <label for="variationTitle${variationCount}" class="form-label mb-0">Заголовок</label>
                        <button type="button" class="btn btn-sm btn-outline-danger delete-variation-btn" data-index="${variationCount}">
                            <i class="bi-trash"></i>
                        </button>
                    </div>
                    <div>
                        <input type="text" class="form-control variation-title" id="variationTitle${variationCount}" data-index="${variationCount}" required />
                    </div>
                    <div class="mt-2">
                        <label for="variationText${variationCount}" class="form-label">Текст промпта</label>
                        <textarea class="form-control variation-text" id="variationText${variationCount}" rows="3" data-index="${variationCount}" required></textarea>
                    </div>
                </div>
            `;
            variationsContainer.insertAdjacentHTML('beforeend', newVariationHTML);
            addDeleteVariationListeners();
        }

        function addDeleteVariationListeners() {
            document.querySelectorAll('.delete-variation-btn').forEach(button => {
                button.addEventListener('click', (e) => {
                    const variationCard = e.target.closest('.card');
                    if (variationCard) {
                        variationCard.remove();
                    }
                });
            });
        }

        function savePrompt() {
          const promptTabNameInput = document.getElementById("promptTabNameInput");
          const promptTabName = promptTabNameInput.value.trim();

          if (!promptTabName) {
            promptTabNameInput.classList.add("is-invalid");
            return;
          }

          promptTabNameInput.classList.remove("is-invalid");
          
          const variationTitles = document.querySelectorAll(".variation-title");
          const variationTexts = document.querySelectorAll(".variation-text");
          const variations = [];

          let hasError = false;
          variationTitles.forEach((titleInput, index) => {
            const title = titleInput.value.trim();
            const text = variationTexts[index].value.trim();
            if (!title || !text) {
              titleInput.classList.add("is-invalid");
              variationTexts[index].classList.add("is-invalid");
              hasError = true;
            } else {
              titleInput.classList.remove("is-invalid");
              variationTexts[index].classList.remove("is-invalid");
              const existingId = promptIdToEdit && findPrompt(promptIdToEdit).variations[index] ? findPrompt(promptIdToEdit).variations[index].id : null;
              variations.push({
                id: existingId || `v${Date.now() + Math.random().toString(36).substring(2, 5)}`,
                title,
                text,
              });
            }
          });

          if (hasError) {
              return;
          }

          if (promptIdToEdit) {
            const existingPrompt = findPrompt(promptIdToEdit);
            if (existingPrompt) {
              existingPrompt.tabName = promptTabName;
              existingPrompt.variations = variations;
              activePromptId = existingPrompt.id;
            }
          } else {
            const newPromptId = `p${Date.now() + Math.random().toString(36).substring(2, 5)}`;
            prompts.push({ id: newPromptId, tabName: promptTabName, variations, isDefault: false });
            activePromptId = newPromptId;
          }

          savePrompts();
          renderUI();
          promptModal.hide();
        }

        function deletePrompt() {
          if (!promptIdToDelete) return;
          prompts = prompts.filter(p => p.id !== promptIdToDelete);
          savePrompts();
          if (prompts.length > 0) {
            activePromptId = prompts[0].id;
          } else {
            activePromptId = null;
          }
          renderUI();
          deleteConfirmModal.hide();
          promptIdToDelete = null;
        }

        // --- INITIALIZATION ---
        addPromptBtn.addEventListener('click', handleAdd);
        confirmDeleteBtn.addEventListener('click', deletePrompt);
        addVariationBtn.addEventListener('click', addVariationField);

        // Слушатель для валидации названия промпта
        promptTabNameInput.addEventListener('input', () => {
          promptTabNameInput.classList.toggle('is-invalid', !promptTabNameInput.value.trim());
        });

        // Запуск функции, которая добавляет обработчики событий для кнопок "Сохранить", "Копировать" и "Редактировать"
        addEventListenersToControls();

        loadPrompts();
        renderUI();
      });
    </script>
  </body>
</html>
